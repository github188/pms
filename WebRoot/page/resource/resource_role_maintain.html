<!DOCTYPE html>
<html>
  <head>
    <title>resource_role_maintain.html</title>
	
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="this is my page">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    
    <!--<link rel="stylesheet" type="text/css" href="./styles.css">-->

  </head>
  
  <body>
	<div class="easyui-layout" data-options="fit:true,border:false">
		<div region="north" data-options="split:false,border:true"  style="height:45px;line-height:42px;padding-left:5px;background: url(../images/white-top-bottom.gif) repeat-x;">
			<b>当前位置：<span style="color:blue">角色维护</span></b>
		</div>
		<div id="content" region="center" data-options="border:true,noheader:true" style="padding:3px;">
			<div id="resource_role_manage_center_main_wapper" class="easyui-panel" data-options="border:false,fit:true">
		    	<div id="resource_role_manage_center_main" class="easyui-layout" data-options="fit:true" >
		    		<div id="resource_role_manage_center_query" region="north" data-options="border:false,noheader:true" style="margin-bottom:5px;">
		    			<table class="nodt" style="width:100%">
			                <tr>
			                    <td class="query_name_small text_right">名称</td>
			                    <td class="query_value_small"><input id="resource_role_query_name" class="easyui-textbox"></input></td>
			                    <td class="query_name_small text_right">编码</td>
			                    <td class="query_value_small"><input id="resource_role_query_code" class="easyui-textbox"></input></td>
			                    <td>
			                    	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="queryResourceRole()">查询</a>
	            					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="clearQueryOrgCondition()">重置</a>
			                    </td>
			                </tr>
			            </table>
		    		</div><!-- end of resource_role_manage_center_query -->
		    		
		    		<div id="resource_role_manage_center_list" region="center" data-options="border:false,noheader:true" >
		    			<table class="nodt" id="resource_role_manage_center_list_dg"  
					            data-options="singleSelect:false,method:'post',nowrap:true,idField:'id',toolbar:'#toolbar',pagination:true,noheader:true,fit:true">
					        <thead>
					            <tr>
					            	<th field="ck" checkbox="true"></th>
					                <th data-options="field:'BUSINESS_ROLE_NAME'" style="width:33%;">名称</th>
					                <th data-options="field:'BUSINESS_ROLE'" style="width:33%;">编码</th>
					                <th data-options="field:'ROLE_DESC'" style="width:33%;">描述</th>
					            </tr>
					        </thead>
					    </table>
					    <div id="toolbar" style="background-color:#E7F0FF">
					    	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="addResourceRole()">添加</a>
	            			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true" onclick="modResourceRole()">修改</a>
	            			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="delResourceRole()">删除</a>
	            			
					    </div><!-- end of toolbar -->
		    		</div><!-- end of resource_role_manage_center_list -->
		    		
		    	</div><!-- end of resource_role_manage_center_main -->

			</div><!-- resource_role_manage_center_main_wapper -->
			
			<div id="resource_role_manage_center_detail_wapper" class="easyui-panel" data-options="fit:true,closed:true" >
				<div id="resource_role_manage_center_detail" class="easyui-panel" 
								data-options="fit:true,border:false,title:'基本信息',footer:'#resource_role_manage_center_detail_ft'" >
					<div id="message" style="width=100%;height:30px;text-align:center;line-height:30px;display:none"></div>
					<input id="role_id" type="hidden"/>
					<input id="role_data_version" type="hidden"/>
					<input id="roleOrg_data_version" type="hidden"/>
			        <table class="nodt" style="width:100%">
			            <tr>
			                <td class="form_name_small text_right"><span style="color:red;">*</span> 角色名称</td>
			                <td><input id="role_name" class="form_value_mid easyui-textbox" data-options="prompt:'请输入角色名称'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"><span style="color:red;">*</span> 角色编码</td>
			                <td><input id="role_code" class="form_value_mid easyui-textbox" data-options="editable:false,prompt:'此项由后台生成'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"> 角色类型</td>
			                <td><input id="role_type" class="form_value_mid easyui-textbox" data-options="prompt:'请输入角色类型'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"> 目标地市</td>
			                <td>
			                	<input id="roleOrg_destcity" class="form_value_mid easyui-textbox" data-options="prompt:'请选择目标地市',editable:false"></input>
			                	<a href="javascript:void(0)" id="openOrgSelectWin_linkbutton" class="easyui-linkbutton" data-options="iconCls:'icon-save',disabled: true" onclick="openOrgSelectWin()">选择</a>
			                </td>
			            </tr>
			            <tr> 
			                <td class="form_name_small text_right"> 系统类型</td>
			                <td><input id="role_systype" class="form_value_mid easyui-textbox" data-options="prompt:'请输入系统类型'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"> 来源地市</td>
			                <td><input id="role_srccity" class="form_value_mid easyui-textbox" data-options="prompt:'请输入来源地市'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"> 删除状态</td>
			                <td><input id="role_delstatus" class="form_value_mid easyui-textbox" data-options="prompt:'请选择删除状态'"></input></td>
			            </tr>
			            <tr>
			                <td class="form_name_small text_right"> 描述</td>
			                <td><input id="role_describe" class="form_value_mid easyui-textbox" data-options="prompt:'请输入描述'"></input></td>
			            </tr>
					</table>

					<table class="nodt" id="role_resource_feature_dg" >
				    </table>
				    <div id="featureToolbar" style="background-color:#E7F0FF">
				    	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="roleQueryResourceFeature()">添加</a>
				    </div><!-- end of featureToolbar -->
				    
				    <table class="nodt" id="role_resource_data_dg" >
				    </table>
				    <div id="dataToolbar" style="background-color:#E7F0FF">
				    	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="roleQueryResourceData()">添加</a>
				    </div><!-- end of featureToolbar -->
				    
				    <div id="org_query_win" class="easyui-window" title="组织机构" style="width:80%;height:80%;"
				    		data-options="iconCls:'icon-save',draggable:false,inline:true,modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false" >
				        <div class="easyui-layout" data-options="fit:true">
				            <div data-options="region:'west',split:false" style="width:200px">
				            	<div class="easyui-panel" data-options="fit:true,border:true,noheader:true">
						        <ul id="org_query_tree" class="easyui-tree" data-options="url:'../organization/queryChildrenNodes.action'">
						        </ul><!-- end of org_query_tree -->
						        </div>
				            </div><!-- end of west -->
				            <div data-options="region:'center'">
				                <div class="easyui-panel" data-options="fit:true,border:true,noheader:true">
				                	<table class="nodt" id="org_query_list_dg"  
							            data-options="singleSelect:true,method:'post',nowrap:true,idField:'id',toolbar:'#org_query_list_dg_tb',pagination:true,noheader:true,fit:true">
								        <thead>
								            <tr>
								                <th data-options="field:'name'" style="width:33%;">机构名称</th>
								                <th data-options="field:'id'" style="width:33%;">机构编码</th>
								                <th data-options="field:'pname'" style="width:33%;">上级机构</th>
								            </tr>
								        </thead>
								    </table>
								    <div id="org_query_list_dg_tb" style="background-color:#E7F0FF">
								    	<table class="nodt" style="width:100%">
							                <tr>
							                    <td class="query_name_small text_right noborder" style="border:0;">机构名称</td>
							                    <td class="query_value_small noborder" style="border:0;"><input id="org_query_win_name" class="easyui-textbox"></input></td>
							                    <td class="query_name_small text_right noborder" style="border:0;">机构编码</td>
							                    <td class="query_value_small noborder" style="border:0;"><input id="org_query_win_uid" class="easyui-textbox"></input></td>
							                    <td class="text_right noborder" style="border:0;">
							                    	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="orgQueryWinQueryOrg()">查询</a>
							                    	<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-reload'" onclick="orgQueryWinClearQueryOrgCondition()">重置</a>
							                    </td>
							                </tr>
							            </table>
								    </div><!-- end of toolbar -->
				                </div>
				            </div><!-- end of center -->
				        </div>
				    </div><!-- end of org_query_win -->
				    
				</div><!-- end of resource_role_manage_center_detail -->
				<div id="resource_role_manage_center_detail_ft" style="text-align:center;height:45px;padding-top:15px;">
					<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="addRoleSave();">保存</a>
					<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-edit'" onclick="addRoleReturn();">返回</a>
				</div><!-- end of resource_role_manage_center_detail_ft -->
				
				<div id="resource_role_query_resource_feature_win" class="easyui-window" title="功能资源" style="width:80%;height:500px;"
						data-options="iconCls:'icon-save',draggable:false,inline:true,modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false" >
					<div id="resource_role_query_resource_feature_win_main" class="easyui-layout" data-options="fit:true" >
						<div class="easyui-panel" data-options="fit:true,footer:'#resource_role_query_resource_feature_win_ft'">				
							<table class="nodt" id="resource_role_query_resource_feature_win_list_dg"  
						            data-options="singleSelect:false,method:'post',nowrap:true,idField:'id',pagination:true,noheader:true,fit:true">
						        <thead>
						            <tr>
						            	<th field="ck" checkbox="true"></th>
						                <th data-options="field:'name'" style="width:33%;">名称</th>
						                <th data-options="field:'resource_id'" style="width:33%;">编码</th>
						                <th data-options="field:'resource_describe'" style="width:33%;">描述</th>
						            </tr>
						        </thead>
						    </table>
						</div>
						<div id="resource_role_query_resource_feature_win_ft" style="padding:5px;text-align:center">
					        <a href="javascript:void(0)" class="easyui-linkbutton" style="width:80px;" onclick="roleQueryResourceFeatureConfirm();">确定</a>
	                    	<a href="javascript:void(0)" class="easyui-linkbutton" style="width:80px;" onclick="roleQueryResourceFeatureReturn();">返回</a>
					    </div>
					    
				    </div><!--  end of resource_role_query_resource_feature_win_main -->
				</div><!--   end of resource_role_query_resource_feature_win --> 	
					
				<div id="resource_role_query_resource_data_win" class="easyui-window" title="数据资源" style="width:100%;height:500px;"
						data-options="iconCls:'icon-save',draggable:false,inline:true,modal:true,closed:true,collapsible:false,minimizable:false,maximizable:false" >
					<div id="resource_role_query_resource_data_win_main" class="easyui-layout" data-options="fit:true" >
						<div class="easyui-panel" data-options="fit:true,footer:'#resource_role_query_resource_data_win_ft'">
					    	<div id="resource_role_query_resource_data_win_list_dg_tb" region="north" data-options="border:false,noheader:true" style="margin-bottom:5px;">
				    			<table class="nodt" style="width:100%">
					                <tr>
					                    <td class="query_name_small text_right">资源唯一标识</td>
					                    <td class="query_value_small"><input id="resource_data_query_resource_id" class="easyui-textbox"></input></td>
					                    <td class="query_name_small text_right">资源状态</td>
					                    <td class="query_value_small"><input id="resource_data_query_resource_status" class="easyui-textbox query_value_mid"></input></td>					                
					                </tr>
									<tr>
					                    <td class="detail_query_name text_right">资源描述</td>
					                    <td class="detail_query_value"><input id="resource_data_query_resource_describe" class="easyui-textbox"></input></td>
					                    <td class="detail_query_name text_right">备注</td>
					                    <td class="detail_query_value"><input id="resource_data_query_resource_remark" class="easyui-textbox"></input></td>	
					                </tr>
					                <tr>
					                    <td class="detail_query_name text_right">删除状态</td>
					                    <td class="detail_query_value"><input id="resource_data_query_delete_status" class="easyui-textbox query_value_mid"></input></td>
					                    <td class="detail_query_name text_right">资源类型</td>
					                    <td class="detail_query_value"><input id="resource_data_query_resource_type" class="easyui-textbox query_value_mid"></input></td>	
					                </tr>
					                <tr>
					                 <td class="detail_query_name text_right">字段分类关系编码</td>
					                    <td class="detail_query_value"><input id="resource_data_query_section_relatioin_class" class="easyui-textbox query_value_mid"></input></td>
					                    <td class="detail_query_name text_right">数据集敏感度编码</td>
					                    <td class="detail_query_value"><input id="resource_data_query_dataset_sensitive_level" class="easyui-textbox query_value_mid"></input></td>	
					                </tr>
					                <tr>
					                    <td class="detail_query_name text_right">数据集编码</td>
					                    <td class="detail_query_value"><input id="resource_data_query_data_set" class="easyui-textbox query_value_mid"></input></td>
					                    <td class="detail_query_name text_right">字段分类编码</td>
					                    <td class="detail_query_value"><input id="resource_data_query_section_class" class="easyui-textbox query_value_mid"></input></td>	
					                </tr>
					                <tr>
					                    <td class="detail_query_name text_right">字段编码</td>
					                    <td class="detail_query_value"><input id="resource_data_query_element" class="easyui-textbox query_value_mid"></input></td>
<!-- 					                    <td class="detail_query_name text_right">目标地市</td> -->
<!-- 					                    <td class="detail_query_value"><input id="resource_data_query_clue_dst_sys" class="easyui-textbox"></input></td> -->
					                </tr>
					                <tr>
					                	<td class="text_center noborder" style="border:0;" colspan="4">
					                    	<a href="javascript:void(0)" class="easyui-linkbutton" onclick="queryResourceData()">查询</a>
					                    </td>
					                </tr>					                
					            </table>
				    			
								<table class="nodt" id="resource_role_query_resource_data_win_list_dg"  
							            data-options="singleSelect:false,method:'post',nowrap:true,idField:'id',pagination:true,noheader:true,fit:true">
							        <thead>
							            <tr>
							            	<th field="ck" checkbox="true"></th>
							                <th data-options="field:'name'">名称</th>
							                <th data-options="field:'RESOURCE_ID'">资源唯一标识</th>
							                <th data-options="field:'RESOURCE_STATUS'">资源状态 </th>
							                <th data-options="field:'RESOURCE_DESCRIBE'">资源描述</th>
							                <th data-options="field:'RESOURCE_REMARK'">备注</th>
							                <th data-options="field:'DELETE_STATUS'">删除状态 </th>
							                <th data-options="field:'resource_type'">资源类型</th>
<!-- 							                <th data-options="field:'CLUE_DST_SYS'">目标地市</th> -->
							                <th data-options="field:'DATASET_SENSITIVE_LEVEL'">数据集敏感度编码 </th>					                
							                <th data-options="field:'DATA_SET'">数据集编码</th>
							                <th data-options="field:'SECTION_CLASS'">字段分类编码</th>
							                <th data-options="field:'ELEMENT'">字段编码</th>
							                <th data-options="field:'SECTION_RELATIOIN_CLASS'">字段分类关系编码 </th>
							            </tr>
							        </thead>
							    </table>
						    </div><!-- end of resource_role_query_resource_data_win_list_dg_tb -->
						</div>
						<div id="resource_role_query_resource_data_win_ft" style="padding:5px;text-align:center">
					        <a href="javascript:void(0)" class="easyui-linkbutton" style="width:80px;" onclick="roleQueryResourceDataConfirm();">确定</a>
	                    	<a href="javascript:void(0)" class="easyui-linkbutton" style="width:80px;" onclick="roleQueryResourceDataReturn();">返回</a>
					    </div>
					    
				    </div><!-- end of resource_role_query_resource_data_win_main -->
				</div><!-- end of resource_role_query_resource_data_win -->
		
	    	</div><!-- end of resource_role_manage_center_detail_wapper -->
		</div>
	
	</div><!-- end of layout -->
<script>
	function queryResourceData(){
		var resId = $("#resource_data_query_resource_id").textbox('getValue');

		var resource_data_query_resource_status = $('#resource_data_query_resource_status').combobox('getValues');
		var resStatus = "";
	        for(var i = 0; i < resource_data_query_resource_status.length; i++){
				resStatus += resource_data_query_resource_status[i].toString();
				if( i < resource_data_query_resource_status.length - 1 ){
					resStatus += ',';
				}
			}
		
		var resDescribe = $("#resource_data_query_resource_describe").textbox('getValue');
		
		var resRemark = $("#resource_data_query_resource_remark").textbox('getValue');
		
		var resource_data_query_delete_status = $('#resource_data_query_delete_status').combobox('getValues');
		var deleteStatus = "";
	        for(var i = 0; i < resource_data_query_delete_status.length; i++){
				deleteStatus += resource_data_query_delete_status[i].toString();
				if( i < resource_data_query_delete_status.length - 1 ){
					deleteStatus += ',';
				}
			}
		
		var resource_data_query_resource_type = $('#resource_data_query_resource_type').combobox('getValues');
		var resTtype = "";
	        for(var i = 0; i < resource_data_query_resource_type.length; i++){
				resTtype += resource_data_query_resource_type[i].toString();
				if( i < resource_data_query_resource_type.length - 1 ){
					resTtype += ',';
				}
			}
			
// 		var resource_data_query_clue_dst_sys = $('#resource_data_query_clue_dst_sys').textbox('getValue');
// 		var clueDstSys=resource_data_query_clue_dst_sys;
		
		var resource_data_query_dataset_sensitive_level = $('#resource_data_query_dataset_sensitive_level').combobox('getValues');
		var datasetSensitiveLevel = "";
	        for(var i = 0; i < resource_data_query_dataset_sensitive_level.length; i++){
				datasetSensitiveLevel += resource_data_query_dataset_sensitive_level[i].toString();
				if( i < resource_data_query_dataset_sensitive_level.length - 1 ){
					datasetSensitiveLevel += ',';
				}
			}
		
		var resource_data_query_data_set = $('#resource_data_query_data_set').combobox('getValues');
		var dataSet = "";
	        for(var i = 0; i < resource_data_query_data_set.length; i++){
				dataSet += resource_data_query_data_set[i].toString();
				if( i < resource_data_query_data_set.length - 1 ){
					dataSet += ',';
				}
			}

		var resource_data_query_section_class = $('#resource_data_query_section_class').combobox('getValues');
		var sectionClass = "";
	        for(var i = 0; i < resource_data_query_section_class.length; i++){
				sectionClass += resource_data_query_section_class[i].toString();
				if( i < resource_data_query_section_class.length - 1 ){
					sectionClass += ',';
				}
			}
		
		var resource_data_query_element = $('#resource_data_query_element').combobox('getValues');
		var element = "";
	        for(var i = 0; i < resource_data_query_element.length; i++){
				element += resource_data_query_element[i].toString();
				if( i < resource_data_query_element.length - 1 ){
					element += ',';
				}
			}
			
		var resource_data_query_section_relatioin_class = $('#resource_data_query_section_relatioin_class').combobox('getValues');
		var sectionRelatioinClass = "";
	        for(var i = 0; i < resource_data_query_section_relatioin_class.length; i++){
				sectionRelatioinClass += resource_data_query_section_relatioin_class[i].toString();
				if( i < resource_data_query_section_relatioin_class.length - 1 ){
					sectionRelatioinClass += ',';
				}
			}

		if (resStatus.substr(0,1)==',') resStatus=resStatus.substr(1);
		if (deleteStatus.substr(0,1)==',') deleteStatus=deleteStatus.substr(1);
		if (resTtype.substr(0,1)==',') resTtype=resTtype.substr(1);
		if (datasetSensitiveLevel.substr(0,1)==',') datasetSensitiveLevel=datasetSensitiveLevel.substr(1);
		if (dataSet.substr(0,1)==',') dataSet=dataSet.substr(1);
		if (sectionClass.substr(0,1)==',') sectionClass=resDescribe.substr(1);
		if (element.substr(0,1)==',') element=element.substr(1);
		if (sectionRelatioinClass.substr(0,1)==',') sectionRelatioinClass=sectionRelatioinClass.substr(1);

		$("#resource_role_query_resource_data_win_list_dg").datagrid('load',{
			resCode: resId,
			resource_status: resStatus,
			resource_describe: resDescribe,
			resource_remark: resRemark,
			delete_status: deleteStatus,
			resource_type: resTtype,
// 			clue_dst_sys: clueDstSys,
			dataset_sensitive_level: datasetSensitiveLevel,
			data_set: dataSet,
			section_class: sectionClass,
			element: element,
			section_relatioin_class: sectionRelatioinClass
		});
	}
	
    function queryResourceRole(){
    	var name = $("#resource_role_query_name").val();
    	var code = $("#resource_role_query_code").val();
     	
    	$("#resource_role_manage_center_list_dg").datagrid('load',{
    		queryAll: true,
			resName: name,
			resCode: code
		});
    }
    
    function openOrgSelectWin(){
    	$('#org_query_win').window('open').window('center');
    }
    
    function orgQueryWinClearQueryOrgCondition(){
    	$("#org_query_win_name").textbox({value:""});
    	$("#org_query_win_uid").textbox({value:""});
    }
    
    function orgQueryWinQueryOrg(){
    	var name = $("#org_query_win_name").val();
    	var uid = $("#org_query_win_uid").val();
    	
    	$("#org_query_list_dg").datagrid('load',{
    		queryAll: true,
			id: 0,
			orgName: name,
			orgUid: uid
		});
    }
    
    function clearQueryOrgCondition(){
    	$("#resource_role_query_name").textbox({value:""});
    	$("#resource_role_query_code").textbox({value:""});
    }
    
    function addResourceRole() {
    	$("#resource_role_manage_center_main_wapper").panel('close');
    	$("#resource_role_manage_center_detail_wapper").panel('open');
    }
    
    function addRoleSave(){
		var roleId = $("#role_id").val();
    	var poststr = "role.id=" + roleId;
    	
    	var roleDataVersion = $("#role_data_version").val();
    	poststr += "&role.DATA_VERSION=" + roleDataVersion;
    	
    	var roleOrgDataVersion = $("#roleOrg_data_version").val();
    	poststr += "&resRoleOrg.DATA_VERSION=" + roleOrgDataVersion;
    	
    	var roleName = $("#role_name").textbox('getValue');
    	poststr += "&role.BUSINESS_ROLE_NAME=" + encodeURIComponent(roleName);
    	
    	var roleCode = $("#role_code").textbox('getValue');
    	poststr += "&role.BUSINESS_ROLE=" + encodeURIComponent(roleCode);
    	
    	var roleType = $("#role_type").combobox('getValue');
    	poststr += "&role.BUSINESS_ROLE_TYPE=" + encodeURIComponent(roleType);
    	
    	var roleDestcity = $("#roleOrg_destcity").textbox('getValue');
    	poststr += "&resRoleOrg.CLUE_DST_SYS=" + encodeURIComponent(roleDestcity);
    	
    	var roleSystype = $("#role_systype").textbox('getValue');
    	poststr += "&role.SYSTEM_TYPE=" + encodeURIComponent(roleSystype);
    	
    	var roleSrccity = $("#role_srccity").textbox('getValue');
    	poststr += "&role.CLUE_SRC_SYS=" + encodeURIComponent(roleSrccity);
    	
    	var roleDelstatus = $("#role_delstatus").combobox('getValue');
    	poststr += "&role.DELETE_STATUS=" + encodeURIComponent(roleDelstatus);
    	
    	var roleDescrib = $("#role_describe").textbox('getValue');
    	poststr += "&role.ROLE_DESC=" + encodeURIComponent(roleDescrib);
    	
     	var rows = $("#role_resource_feature_dg").datagrid('getRows');
     	var index = 0;
    	for(index=0; index < rows.length; index++) {
	 		poststr += '&addFeatureIds=' + rows[index].id;
    	}

		rows = $("#role_resource_data_dg").datagrid('getRows');
    	for(index=0; index < rows.length; index++) {
	 		poststr += '&addDataIds=' + rows[index].id;
    	}
    	$.post("../resource/saveResourceRole.action?rand=" + Math.random(), poststr, function(retObj) {
		
			if(retObj.result == true)
			{
				successTip("提示", '保存角色信息成功');
			}
			else
			{
				warningTip("提示", '保存角色信息失败');	
			}
			addRoleReturn();
		}, "json");
    }
    
    function addRoleReturn(){
    	$("#resource_role_manage_center_main_wapper").panel('open');
    	$("#resource_role_manage_center_main_wapper").panel('resize');
    	$("#resource_role_manage_center_detail_wapper").panel('close');
    	$("#resource_role_manage_center_list_dg").datagrid('reload').datagrid('clearSelections');
    	refreshDetailPage();
    }
    
    function refreshDetailPage() {
		$("#role_id").val("");
		$("#role_data_version").val("");
		$("#roleOrg_data_version").val("");
     	$("#role_name").textbox('setValue',"");
     	$("#role_code").textbox('setValue',"");
     	$("#role_type").textbox('setValue',"");
     	$("#role_type").textbox({ disabled: false});
		$('#openOrgSelectWin_linkbutton').linkbutton({ disabled: false});
     	$("#roleOrg_destcity").textbox('setValue',"");
     	$("#role_systype").textbox('setValue',"");
     	$("#role_srccity").textbox('setValue',"");
     	$("#role_delstatus").textbox('setValue',"");
     	$("#role_describe").textbox('setValue',"");
     	
     	//clear datagrid's data
     	$("#role_resource_feature_dg").datagrid({data: []});
     	$("#role_resource_data_dg").datagrid({data: []});
    }
    
    function modResourceRole(){
    	var rows = $("#resource_role_manage_center_list_dg").datagrid('getSelections');
		if(rows.length == 0) {
			warningTip("提示", '请选择要修改的角色');
			return false;
		} else if (rows.length>1)
		{
			warningTip("提示", '一次只能修改一个角色');
			return false;
		}
		
		$("#role_id").val(rows[0].id);
		$("#role_data_version").val(rows[0].DATA_VERSION);
		$("#roleOrg_data_version").val(rows[0].dest_data_version);
		$("#role_name").textbox('setValue',rows[0].BUSINESS_ROLE_NAME);
		$("#role_code").textbox('setValue',rows[0].BUSINESS_ROLE);
		$("#role_type").textbox({ disabled: true});
		$('#openOrgSelectWin_linkbutton').linkbutton({ disabled: true});
		$("#role_type").textbox('setValue',rows[0].BUSINESS_ROLE_TYPE);
		for(var i=0;i<rows[0].value.length;i++){
			if(rows[0].value[i].attrid == 16 && rows[0].value[i].code == rows[0].BUSINESS_ROLE_TYPE){//角色类型BUSINESS_ROLE_TYPE==16
				$("#role_type").textbox('setText',rows[0].value[i].value);
			}
		};
// 		$("#roleOrg_destcity").textbox('setValue',rows[0].CLUE_DST_SYS);
		$("#roleOrg_destcity").textbox('setValue',rows[0].pid);
		$("#roleOrg_destcity").textbox('setText',rows[0].pname);
		$("#role_systype").textbox('setValue',rows[0].SYSTEM_TYPE);
		$("#role_srccity").textbox('setValue',rows[0].CLUE_SRC_SYS);
		$("#role_delstatus").textbox('setValue',rows[0].DELETE_STATUS);
		for(var i=0;i<rows[0].value.length;i++){
			if(rows[0].value[i].attrid == 17 && rows[0].value[i].code == rows[0].DELETE_STATUS){//删除状态DELETE_STATUS==17
				$("#role_delstatus").textbox('setText',rows[0].value[i].value);
			}
		};
		$("#role_describe").textbox('setValue',rows[0].ROLE_DESC);
		
		//load datagrid's data
		var poststr = "role.BUSINESS_ROLE=" + rows[0].BUSINESS_ROLE;
		$.getJSON("../resource/queryRoleResource.action?rand=" + Math.random(), poststr, function(retObj) {
		
			if(retObj.result == true)
			{
 				var index;
 				for( index=0; index < retObj.features.length; index++) {
 					insertFeature( retObj.features[index]);
 				}
 				for( index=0; index < retObj.dataItems.length; index++) {
 					insertData( retObj.dataItems[index]);
 				}
		    	
//  		    	for( index=0; index < retObj。datas.length; index++ ) {
//  		    		insertData(retObj。datas[index]);
//  		    	}
			}
			else
			{
				warningTip("提示", '获取角色的资源信息失败');	
				refreshDetailPage();
				return;
			}
		});
		
		$("#resource_role_manage_center_main_wapper").panel('close');
   		$("#resource_role_manage_center_detail_wapper").panel('open');
    }
    
    function delResourceRole(){
		var rows = $("#resource_role_manage_center_list_dg").datagrid('getSelections');
		if(rows.length == 0) {
			warningTip("提示", '请选择要删除的角色');
			return;
		}
		else {
			$.extend($.messager.defaults,{  
				ok:"删除",  
				cancel:"取消"  
			});
			$.messager.confirm('确认', '您选取了' + rows.length + '条记录。确认要删除所选角色？', function(r){
                if (r){
                	var poststr = "delIds=" + rows[0].id;
                	for(var i=1; i<rows.length; i++){
					    poststr += "&delIds=" + rows[i].id;
					}

                    $.getJSON("../resource/deleteResourceRole.action", poststr, function(retObj) {
		
						if(retObj.result == true)
						{
							$('#resource_role_manage_center_list_dg').datagrid('reload').datagrid('clearSelections');
							successTip("删除角色","操作成功");
						}
						else
						{
							warningTip("提示", "删除角色操作失败：" + retObj.message);
						}
					});
                }
            });
		}
	}
    
    function roleQueryResourceFeatureReturn(){
    	$("#resource_role_query_resource_feature_win_list_dg").datagrid('clearSelections');
    	$("#resource_role_query_resource_feature_win").window('close');
    }
    function roleQueryResourceDataReturn(){
    	$("#resource_role_query_resource_data_win_list_dg").datagrid('clearSelections');
    	$("#resource_role_query_resource_data_win").window('close');
    }
    
    function roleQueryResourceFeatureConfirm(){
		var res = $("#resource_role_query_resource_feature_win_list_dg").datagrid('getSelections');
    	for( var index=0; index<res.length; index++ ) {
    		insertFeature(res[index]);
    	}
    	return roleQueryResourceFeatureReturn();
    }
    
    function roleQueryResourceDataConfirm(){
		var res = $("#resource_role_query_resource_data_win_list_dg").datagrid('getSelections');
    	for( var index=0; index<res.length; index++ ) {
    		insertData(res[index]);
    	}
    	return roleQueryResourceDataReturn();
    }
    
//    var insertFlag="";
//     function roleQueryResourceConfirm(){
// 		var resFeature = $("#resource_role_query_resource_feature_win_list_dg").datagrid('getSelections');
//     	var resData= $("#resource_role_query_resource_data_win_list_dg").datagrid('getSelections');
    	
//     	for( var index=0; index<resFeature.length; index++ ) {
//     		if ( insertFlag == "feature" ) {
// 	    		insertFeature(resFeature[index]);
// 	    	}
// 	    }
// 	    for( var index=0; index<resData.length; index++ ) {
// 			if ( insertFlag == "data" ) {
// 	    		insertData(resData[index]);
// 	    	}
//     	}
//     	return roleQueryResourceReturn();
//     }
    
    function isExist(data, id) {
    	for(var index = 0; index<data.length; index++) {
    		if(data[index].id == id)
    			return true;
    	}
    	return false;
    }
    
    function insertFeature( data ){
    	var rows = $("#role_resource_feature_dg").datagrid('getRows');
		var index = rows.length;
		
		if( isExist( rows, data.id ) )
			return;
		//for(data.)
    	$("#role_resource_feature_dg").datagrid('insertRow', {
			index: index,
			row:{
				id:data.id, 
				name:data.name, 
				resource_id:data.resource_id, 
				resource_describe:data.resource_describe
			}
		});
		
    }
    
    function insertData(data){
    	var rows = $("#role_resource_data_dg").datagrid('getRows');
		var index = rows.length;
		
		if( isExist( rows, data.id ) )
			return;
			
    	$("#role_resource_data_dg").datagrid('insertRow', {
			index: index,
			row:{
				id:data.id, 
				name:data.name, 
				RESOURCE_ID:data.RESOURCE_ID, 
				RESOURCE_STATUS:data.RESOURCE_STATUS,
				RESOURCE_DESCRIBE:data.RESOURCE_DESCRIBE, 
				RESOURCE_REMARK:data.RESOURCE_REMARK,
				DELETE_STATUS:data.DELETE_STATUS, 
				resource_type:data.resource_type,
				CLUE_DST_SYS:data.CLUE_DST_SYS,
				DATASET_SENSITIVE_LEVEL:data.DATASET_SENSITIVE_LEVEL,
				DATA_SET:data.DATA_SET,
				SECTION_CLASS:data.SECTION_CLASS,
				ELEMENT:data.ELEMENT,
				SECTION_RELATIOIN_CLASS:data.SECTION_RELATIOIN_CLASS
			}
		});
	}
    //------------------for value edit datagrid-------
    function roleQueryResourceFeature(){
    	$("#resource_role_query_resource_feature_win_list_dg").datagrid({
			url:'../resource/queryFeatureItems.action',
			loadFilter: function(data){
				var res = new Object();
				if (data.result == true){
					res.total = data.total;
					res.rows = data.features;
				} else {
					res.total=0;
					res.rows = [];
				}
				return res;
			}
		});
	   	$("#resource_role_query_resource_feature_win").window({title:'可用值'}).window('open').window('center');
	   	//insertFlag = 'feature';
    }
        
    function roleQueryResourceData(){
    	$("#resource_role_query_resource_data_win_list_dg").datagrid({
			url:'../resource/queryDataItems.action',
			loadFilter: function(data){
				var res = new Object();
				if (data.result == true){
					res.total = data.total;
					res.rows = data.dataItems;
				} else {
					res.total=0;
					res.rows = [];
				}
				return res;
			}
		});
	   	$("#resource_role_query_resource_data_win").window({title:'可用值'}).window('open').window('center');
	   	//insertFlag = 'data';
    }
    
    
    function getRowIndex(target){
		var tr = $(target).closest('tr.datagrid-row');
		return parseInt(tr.attr('datagrid-row-index'));
	}
	
	function featureDeleterow(target){
		$.messager.confirm('Confirm','Are you sure?',function(r){
			if (r){
				$("#role_resource_feature_dg").datagrid('deleteRow', getRowIndex(target));
			}
		});
	}
	
	function dataDeleterow(target){
		$.messager.confirm('Confirm','Are you sure?',function(r){
			if (r){
				$("#role_resource_data_dg").datagrid('deleteRow', getRowIndex(target));
			}
		});
	}
$(document).ready(function () { 
	
	$("#resource_role_manage_center_list_dg").datagrid({
		url:'../resource/queryRoleItems.action',
		loadFilter: function(data){
			var res = new Object();
			if (data.result == true){
				res.total = data.total;
				res.rows = data.roleItems;
			} else {
				res.total=0;
				res.rows = [];
			}
			return res;
		},
//		onLoadSuccess: function() {alert("success");},
		onLoadError: function() { $("#resource_role_manage_center_main").layout('resize',{width:'100%',height:'100%'}); }
	});

	$("#role_resource_feature_dg").datagrid({
		title:'功能资源',
		iconCls:'icon-edit',
		nowrap:true,
		height:'30%',
		toolbar:'#featureToolbar',
		singleSelect:true,
		pagination:false,
		idField:'id',
		//url:'data/datagrid_data.json',
		columns:[[
			{field:'name',title:'名称',width:'30%',editor:'text'},
			{field:'resource_id',title:'编码',width:'30%',editor:'text'},
			{field:'resource_describe',title:'描述',width:'30%',editor:'text'},
			{field:'action',title:'操作',width:'10%',align:'center',
				formatter:function(value,row,index){
					return '<a href="#" onclick="featureDeleterow(this)">删除</a>';
				}
			}
		]]
	});

	$("#role_resource_data_dg").datagrid({
		title:'数据资源',
		iconCls:'icon-edit',
		nowrap:true,
		height:'30%',
		toolbar:'#dataToolbar',
		singleSelect:true,
		pagination:false,
		//idField:'id',
		//url:'data/datagrid_data.json',
		columns:[[
			{field:'name',title:'名称',width:'7%',editor:'text'},
			{field:'RESOURCE_ID',title:'资源唯一标识',width:'7%',editor:'text'},
			{field:'RESOURCE_STATUS',title:'资源状态',width:'7%',editor:'text'},
			{field:'RESOURCE_DESCRIBE',title:'资源描述',width:'7%',editor:'text'},
			{field:'RESOURCE_REMARK',title:'备注',width:'7%',editor:'text'},
			{field:'DELETE_STATUS',title:'删除状态',width:'7%',editor:'text'},			
			{field:'resource_type',title:'资源类型',width:'7%',editor:'text'},
// 			{field:'CLUE_DST_SYS',title:'目标地市',width:'7%',editor:'text'},
			{field:'DATASET_SENSITIVE_LEVEL',title:'数据集敏感度编码 ',width:'10%',editor:'text'},
			{field:'DATA_SET',title:'数据集编码',width:'7%',editor:'text'},
			{field:'SECTION_CLASS',title:'字段分类编码',width:'7%',editor:'text'},
			{field:'ELEMENT',title:'字段编码',width:'7%',editor:'text'},
			{field:'SECTION_RELATIOIN_CLASS',title:'字段分类关系编码',width:'10%',editor:'text'},
			{field:'action',title:'操作',width:'4%',
				formatter:function(value,row,index){
					return '<a href="#" onclick="dataDeleterow(this)">删除</a>';
				}
			}
		]]
	});
	
	$('#org_query_tree').tree({
	    loadFilter: function(data){
	        if (data.treeNodes){
	            return data.treeNodes;
	        } else {
	            return data;
	        }
	    },
	    onClick: function(node){
	    	//alert(node.id);
			$("#roleOrg_destcity").textbox('setValue',node.id);
			$("#roleOrg_destcity").textbox('setText',node.text);
			$('#org_query_win').window('close');
	    }
	});
	
	$("#org_query_list_dg").datagrid({
		url:'../organization/queryChildrenItems.action',
		queryParams:{queryAll: true},
		loadFilter: function(data){
			var res = new Object();
			if (data.result == true){
				res.total = data.total;
				res.rows = data.items;
			} else {
				res.total=0;
				res.rows = [];
			}
			return res;
		},
		onSelect: function(index,row) {
			$("#roleOrg_destcity").textbox('setValue',row.id);
			$("#roleOrg_destcity").textbox('setText',row.name);
			$('#org_query_win').window('close');
		},
//		onLoadSuccess: function() {alert("success");},
		onLoadError: function() { $("#org_query_list_dg").layout('resize',{width:'100%',height:'100%'}); }
	});
	
	$.getJSON("../system/queryResourceDataAttrs.action", function(data) {
		var resource_status="";				//资源状态
		var delete_status="";				//删除状态
		var resource_type="";				//资源类型
		var dataset_sensitive_level="";		//数据集敏感度编码
		var data_set="";					//数据集编码
		var section_class="";				//字段分类编码
		var element="";						//字段编码
		var section_relatioin_class="";		//字段分类关系编码
		
		for(var i=0;i<data.items[0].dictionary.length;i++){
			resource_status+= "{id:'"+data.items[0].dictionary[i].code+"',text:'"+data.items[0].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[1].dictionary.length;i++){
			delete_status+= "{id:'"+data.items[1].dictionary[i].code+"',text:'"+data.items[1].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[2].dictionary.length;i++){
			resource_type+= "{id:'"+data.items[2].dictionary[i].code+"',text:'"+data.items[2].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[3].dictionary.length;i++){
			dataset_sensitive_level+= "{id:'"+data.items[3].dictionary[i].value+"',text:'"+data.items[3].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[4].dictionary.length;i++){
			data_set+= "{id:'"+data.items[4].dictionary[i].value+"',text:'"+data.items[4].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[5].dictionary.length;i++){
			section_class+= "{id:'"+data.items[5].dictionary[i].value+"',text:'"+data.items[5].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[6].dictionary.length;i++){
			element+= "{id:'"+data.items[6].dictionary[i].value+"',text:'"+data.items[6].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[7].dictionary.length;i++){
			section_relatioin_class+= "{id:'"+data.items[7].dictionary[i].value+"',text:'"+data.items[7].dictionary[i].value+"'},"; 
		};

		var resource_statusData='([' + resource_status.substring(0,resource_status.length-1) + '])';
 		var resource_statusJSON = (new Function('return '+resource_statusData +';'))();
 		var delete_statusData='([' + delete_status.substring(0,delete_status.length-1) + '])';
 		var delete_statusJSON = (new Function('return '+delete_statusData +';'))();
 		var resource_typeData='([' + resource_type.substring(0,resource_type.length-1) + '])';
 		var resource_typeJSON = (new Function('return '+resource_typeData +';'))(); 
 		var dataset_sensitive_levelData='([' + dataset_sensitive_level.substring(0,dataset_sensitive_level.length-1) + '])';
 		var dataset_sensitive_levelJSON = (new Function('return '+dataset_sensitive_levelData +';'))(); 
 		var data_setData='([' + data_set.substring(0,data_set.length-1) + '])';
 		var data_setJSON = (new Function('return '+data_setData +';'))(); 
 		var section_classData='([' + section_class.substring(0,section_class.length-1) + '])';
 		var section_classJSON = (new Function('return '+section_classData +';'))();
 		var elementData='([' + element.substring(0,element.length-1) + '])';
 		var elementJSON = (new Function('return '+elementData +';'))(); 
 		var section_relatioin_classData='([' + section_relatioin_class.substring(0,section_relatioin_class.length-1) + '])';
 		var section_relatioin_classJSON = (new Function('return '+section_relatioin_classData +';'))(); 
 		
 		resource_statusJSON.unshift({"id":"","text":"请选择","selected":true});
		delete_statusJSON.unshift({"id":"","text":"请选择","selected":true});
		resource_typeJSON.unshift({"id":"","text":"请选择","selected":true});
		dataset_sensitive_levelJSON.unshift({"id":"","text":"请选择","selected":true});
		data_setJSON.unshift({"id":"","text":"请选择","selected":true});
		section_classJSON.unshift({"id":"","text":"请选择","selected":true});
		elementJSON.unshift({"id":"","text":"请选择","selected":true});
		section_relatioin_classJSON.unshift({"id":"","text":"请选择","selected":true});
		
 		//查询部分
		$('#resource_data_query_resource_status').combobox({
			data : resource_statusJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_delete_status').combobox({
			data : delete_statusJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_resource_type').combobox({
			data : resource_typeJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_dataset_sensitive_level').combobox({
			data : dataset_sensitive_levelJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_data_set').combobox({
			data : data_setJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_section_class').combobox({
			data : section_classJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_element').combobox({
			data : data_setJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
		});
		$('#resource_data_query_section_relatioin_class').combobox({
			data : section_classJSON,
			valueField:'id',
			textField:'text',
			multiple:true,
			editable:false,
			panelHeight:'auto'
			
		});

	});	
	
	$.getJSON("../system/queryRoleAttrs.action", function(data) {
		var business_role_type="";				//角色类型
		var delete_status="";					//删除状态
		
		for(var i=0;i<data.items[0].dictionary.length;i++){
			business_role_type+= "{id:'"+data.items[0].dictionary[i].code+"',text:'"+data.items[0].dictionary[i].value+"'},"; 
		};
		for(var i=0;i<data.items[1].dictionary.length;i++){
			delete_status+= "{id:'"+data.items[1].dictionary[i].code+"',text:'"+data.items[1].dictionary[i].value+"'},"; 
		};
		
		var business_role_typeData='([' + business_role_type.substring(0,business_role_type.length-1) + '])';
		var business_role_typeJSON = (new Function('return '+business_role_typeData +';'))();
 		var delete_statusData='([' + delete_status.substring(0,delete_status.length-1) + '])';
 		var delete_statusJSON = (new Function('return '+delete_statusData +';'))();
 		
		business_role_typeJSON.unshift({"id":"","text":"请选择","selected":true});
		delete_statusJSON.unshift({"id":"","text":"请选择","selected":true});
		
 		//添加部分
		$('#role_type').combobox({
			data : business_role_typeJSON,
			valueField:'id',
			textField:'text',
			onChange:function(){  
		    	var roleType = $("#role_type").combobox("getValue");
		    	if(roleType != 2){
		    		$("#roleOrg_destcity").textbox({value:""});
					$('#openOrgSelectWin_linkbutton').linkbutton({ disabled: true});
    			}else{
    				$('#openOrgSelectWin_linkbutton').linkbutton({ disabled: false});
    			}
    			
    		}
		});
		$('#role_delstatus').combobox({
			data : delete_statusJSON,
			valueField:'id',
			textField:'text'
		});


	});	
});
</script>	
  </body>
</html>
